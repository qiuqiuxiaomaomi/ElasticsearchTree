# ElasticsearchTree
es搜索


![](https://i.imgur.com/0ujSKwB.jpg)

<pre>
Elasticsearch
   ElasticSearch基本概念
      1）索引
	      是ES存放数据的地方。索引可以理解为关系型数据库中的数据表
	  2）文档
          文档是ES中存储的主要实体，ES中的文档可以理解为关系型数据库中的一行记录
      3）文档类型
      5）节点和集群
          ES可以作为一个独立的搜索服务器工作，多台服务器组成一个集群，每台服务器称为一个节点node,可以通过索引分片将海量的
        数据分割分不到不同节点。通过副本机制可以实现更高的性能和更好强的可用性。
	  6）分片
          当需要存储大规模文档时，由于RAM限制，硬盘容量等的限制，仅适用一个节点是不够的，另一个问题是一个节点的计算能力达不到
        所期望的复杂功能的要求。在这种情况下，可以将数据切分，每部分是一个单独的Apache Lucene索引，称为分片。每个分片可以被存储在
        不同节点。当需要查询一个由多个分片构成的索引时，ES将该查询发送到相关的分片，并将结果合并。
      7）副本
          为了提高查询的吞吐量或实现高可用性，可以开启分片副本功能。副本分片是对原始分片的一个精确拷贝，原始分片被称为主分片。对索引的
        所有修改操作都直接作用在主分片上，每个主分片可以有零个或者多个副本分片。当主分片丢失时，集群可以将一个副本分片提升为新的主分片。

      1）安装与运行
         1）安装Java
         2）与ES交互的主要接口是基于HTTP协议和REST API。
	     3）集群名称&&节点名称
         cluster.name 保存集群的名称，通过集群名称可以区分不同的器群，配置具有相同名称的节点将尝试形成一个集群。
         node.name 节点名称。用户可以不指定节点名称，ES会自动为节点选择一个唯一名称，每次启动时都会选择，导致的结果就是每次启动，节点的名称都会变化。	

    2) 数据操作（put,get/delete）
    1）更新文档
        ES中更新文档是非常复杂的工作，ES必须先提取文档，从"_source"字段获取数据，移除旧文档，应用变更，并作为一个新文档创建索引。   

    3）创建索引与配置映射
        ES是一个无模式的搜索引擎并且可以自动匹配数据的结构。但是认为定义和控制数据结构是更好的方式。	
        ES的索引是ES存储数据的一种逻辑结构。可以把它想象成数据库中的包含行和列的表。行是索引中的一个文档，列是索引中的字段。ES可以同时运行多个索引。
        模式映射：
            用来定义索引结构。
	        例如：
	        {
		        "mappings":{
			        "bonaparte":{
				        "properties":{
					        "id":{
						        "type":"long",
							    "store":"yes"
						    },
                            "name":{
                                 "type": "text",
                                 "similarity": "BM25",
                                 "fields": {
                                      "like": {
                                         "type": "text",
                                         "analyzer": "artist_name_like_analyzer"
                                     }
                                } 
                            }
					    }
				    }
			    }
		    }
            文件命名为 ponaparte.json
        分析器：
            分析器以某种方式来分析数据或者查询语句---例如当我们基于空格和小写字母来划分单次时，可以不用担心用户输入的下划线和大写字母。在创建索引及搜索时，ES允许使用不同的分析器，因此可以在搜索的不同阶段选择不同的数据处理方式。使用分析器只需要在相应的字段属性中指定分析器的名称即可。
     	    ES内置的分析器：
               1）standard
	           2) simple
	           3) whitespace
	           5) stop
	           6) keyword
	           7) pattern
	           8) language
	           9) snowball
            除上面的分析器外，ES还支持自定义分析器。自定义分析器需要在映射文件中添加一个settings部分，
               "settings":{
	               "index":{
		               "analysis":{
			               "analyzer":{
				               "sb":{
					               ...
					           }
				            }
			            }
		          }
	          }

    5）动态映射与模板
       1）类型确定机制
          ES通过查看定义某文档的JSON格式就能猜测到文档结构。类型推定

    6）路由选择
       当某个文档需要索引时，ES查看文档的ID以选择应该索引的分片，默认情况下，ES计算文档ID的hash值，并基于该hash值将文档放在某个可用的主分片中，然后这些文档被复制到副本分片。

    8）搜索数据
       搜索和索引的过程
       1）索引过程
	        准备发送数据到ES的文档并在索引中存储文档的过程
	   2）搜索过程
            匹配满足查询条件文档的过程	 
       3）分析过程
       预备字段内容，并将其转换为可以写入Lucene索引的词项（term）的过程。
	        1）词条化
			2）过滤
       5）分析器
            分析器是带有零个或多个过滤器的分词器。
            分析过程在索引过程和分析过程都会用到	
       6) 查询DSL
            将一个查询的请求封装为一个json格式的对象，并发送给ES,这个JSON对象称之为查询DSL
	        1) 简单查询
                1) 搜索类型
                    1）query_and_fetch: 通常是最快也是最简单的搜索类型，查询语句在所有需检查的分片上并行执行，并且所有分片返回结果的规模为size参数的取值，因此该查询返回的文档数据的最大值为size * 分片数目。
	                2）query_then_fetch:查询语句首先得到将文档排序所需的信息，然后得到要获取的文档内容的相关分片，该类型返回的文档数目最大为size的大小
	                3）dfs_query_and_fetch:该类搜索类似于query_and_fetch,除了完成query_and_fetch的工作外，还执行初始查询阶段，该阶段计算分布式的词频以更精确的返回文档打分
	                5）dfs_query_then_fetch：该类型类似于query_then_fetch，除了完成query_then_fetch的工作外，还执行初始查询阶段，该阶段计算分布式词频，以更好完成文档打分
	                6）count:这是一种特殊的搜索类型，只返回匹配查询的文档数目
	                7）scan：这也是一种特殊的搜索类型，该类搜索仅用于预计查询会返回大量结果的时候，它与通常的查询有些不同，因为发送了第一个请求后，
            2) 基本查询

    9）搜索优化 
       1）加权查询
           boost:权值
       2）在映射中定义加权
       3）同义词规则
       5）搜索不同语言的区分处理
       6）使用跨度查询

    10）组合索引，分析，搜索
       1) 使用嵌套文档&&父子关系	
       2) 批量索引以加快索引过程

    11）统计，相似度
    12）集群管理
       当ES根据配置分配所有分片和副本时，集群时可以全面投入使用的，此时都是绿色的
       当出现以下颜色
          1）黄色：主分片已经分配完成，已经做好处理请求的准备，但是某些副本尚未完成分配。
	      2）红色：ES集群尚未准备就绪，其中至少一个主分片没有准备好，
	 当只有一个节点却同时有多个副本时，ES很明显处于黄色状态，因为没有其他节点来放置这些副本。

     Google elasticsearch-head插件
</pre>

<pre>
  基于Restful风格的接口调用方式导入
  基于Rocketmq消息的数据导入
</pre>
  
<pre>
  Lucene中文分词原理与实现
</pre>

<pre>
  使用Solr实现企业搜索
</pre>
